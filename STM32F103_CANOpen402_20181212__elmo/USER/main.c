#include<string.h>
#include "led.h"
#include "delay.h"
#include "key.h"
#include "sys.h"
#include "usart.h"	 
#include "can.h" 

void sdo_StatusTest(void);
void pdo_StatusTest(void);
void position_ParameterSet(void);

#define HEARTBEAT_TIMER_CNT 90


struct TYPE_PID
{
	double kp;
	double ki;
	double kd;
	signed long int err;
	signed long int lerr;
	signed long int plerr;
	signed int pidv;
};

struct TYPE_PID pid={0,0,0,0,0,0,0};



void TIM3_Int_Init(u16 arr,u16 psc);
/*
const int sinDat[4096]={
6,12,18,24,30,36,42,49,55,61,67,73,79,85,92,98,104,110,116,122,128,134,141,147,153,159,165,171,177,184,190,196,
	202,208,214,220,226,233,239,245,251,257,263,269,275,282,288,294,300,306,312,318,324,330,337,343,349,355,361,367,
	373,379,385,392,398,404,410,416,422,428,434,440,446,453,459,465,471,477,483,489,495,501,507,513,520,526,532,538,
	544,550,556,562,568,574,580,586,592,599,605,611,617,623,629,635,641,647,653,659,665,671,677,683,689,695,701,707,
	714,720,726,732,738,744,750,756,762,768,774,780,786,792,798,804,810,816,822,828,834,840,846,852,858,864,870,876,
	882,888,894,900,906,912,918,924,930,936,942,948,954,959,965,971,977,983,989,995,1001,1007,1013,1019,1025,1031,
	1037,1043,1049,1054,1060,1066,1072,1078,1084,1090,1096,1102,1108,1114,1119,1125,1131,1137,1143,1149,1155,1161,
	1166,1172,1178,1184,1190,1196,1202,1207,1213,1219,1225,1231,1237,1243,1248,1254,1260,1266,1272,1277,1283,1289,
	1295,1301,1307,1312,1318,1324,1330,1335,1341,1347,1353,1359,1364,1370,1376,1382,1387,1393,1399,1405,1410,1416,
	1422,1428,1433,1439,1445,1450,1456,1462,1468,1473,1479,1485,1490,1496,1502,1507,1513,1519,1525,1530,1536,1542,
	1547,1553,1558,1564,1570,1575,1581,1587,1592,1598,1604,1609,1615,1620,1626,1632,1637,1643,1648,1654,1660,1665,
	1671,1676,1682,1687,1693,1699,1704,1710,1715,1721,1726,1732,1737,1743,1748,1754,1759,1765,1770,1776,1781,1787,
	1792,1798,1803,1809,1814,1820,1825,1831,1836,1842,1847,1852,1858,1863,1869,1874,1880,1885,1890,1896,1901,1907,
	1912,1917,1923,1928,1934,1939,1944,1950,1955,1960,1966,1971,1976,1982,1987,1992,1998,2003,2008,2014,2019,2024,
	2029,2035,2040,2045,2051,2056,2061,2066,2072,2077,2082,2087,2093,2098,2103,2108,2113,2119,2124,2129,2134,2139,
	2145,2150,2155,2160,2165,2170,2176,2181,2186,2191,2196,2201,2206,2212,2217,2222,2227,2232,2237,2242,2247,2252,
	2257,2262,2267,2272,2278,2283,2288,2293,2298,2303,2308,2313,2318,2323,2328,2333,2338,2343,2348,2353,2358,2362,
	2367,2372,2377,2382,2387,2392,2397,2402,2407,2412,2417,2421,2426,2431,2436,2441,2446,2451,2456,2460,2465,2470,
	2475,2480,2484,2489,2494,2499,2504,2508,2513,2518,2523,2528,2532,2537,2542,2546,2551,2556,2561,2565,2570,2575,
	2579,2584,2589,2593,2598,2603,2607,2612,2617,2621,2626,2631,2635,2640,2644,2649,2654,2658,2663,2667,2672,2677,
	2681,2686,2690,2695,2699,2704,2708,2713,2717,2722,2726,2731,2735,2740,2744,2749,2753,2758,2762,2766,2771,2775,
	2780,2784,2789,2793,2797,2802,2806,2810,2815,2819,2824,2828,2832,2837,2841,2845,2849,2854,2858,2862,2867,2871,
	2875,2879,2884,2888,2892,2896,2901,2905,2909,2913,2917,2922,2926,2930,2934,2938,2943,2947,2951,2955,2959,2963,
	2967,2971,2976,2980,2984,2988,2992,2996,3000,3004,3008,3012,3016,3020,3024,3028,3032,3036,3040,3044,3048,3052,
	3056,3060,3064,3068,3072,3076,3080,3084,3088,3091,3095,3099,3103,3107,3111,3115,3119,3122,3126,3130,3134,3138,
	3141,3145,3149,3153,3157,3160,3164,3168,3172,3175,3179,3183,3186,3190,3194,3198,3201,3205,3209,3212,3216,3220,
	3223,3227,3230,3234,3238,3241,3245,3248,3252,3256,3259,3263,3266,3270,3273,3277,3280,3284,3287,3291,3294,3298,
	3301,3305,3308,3312,3315,3318,3322,3325,3329,3332,3336,3339,3342,3346,3349,3352,3356,3359,3362,3366,3369,3372,
	3376,3379,3382,3385,3389,3392,3395,3398,3402,3405,3408,3411,3414,3418,3421,3424,3427,3430,3434,3437,3440,3443,
	3446,3449,3452,3455,3458,3461,3465,3468,3471,3474,3477,3480,3483,3486,3489,3492,3495,3498,3501,3504,3507,3510,
	3513,3515,3518,3521,3524,3527,3530,3533,3536,3539,3541,3544,3547,3550,3553,3556,3558,3561,3564,3567,3570,3572,
	3575,3578,3581,3583,3586,3589,3591,3594,3597,3600,3602,3605,3607,3610,3613,3615,3618,3621,3623,3626,3628,3631,
	3634,3636,3639,3641,3644,3646,3649,3651,3654,3656,3659,3661,3664,3666,3669,3671,3673,3676,3678,3681,3683,3686,
	3688,3690,3693,3695,3697,3700,3702,3704,3707,3709,3711,3713,3716,3718,3720,3723,3725,3727,3729,3731,3734,3736,
	3738,3740,3742,3745,3747,3749,3751,3753,3755,3757,3759,3761,3764,3766,3768,3770,3772,3774,3776,3778,3780,3782,
	3784,3786,3788,3790,3792,3794,3796,3798,3799,3801,3803,3805,3807,3809,3811,3813,3815,3816,3818,3820,3822,3824,
	3825,3827,3829,3831,3833,3834,3836,3838,3839,3841,3843,3845,3846,3848,3850,3851,3853,3855,3856,3858,3859,3861,
	3863,3864,3866,3867,3869,3870,3872,3874,3875,3877,3878,3880,3881,3883,3884,3885,3887,3888,3890,3891,3893,3894,
	3895,3897,3898,3900,3901,3902,3904,3905,3906,3908,3909,3910,3911,3913,3914,3915,3917,3918,3919,3920,3921,3923,
	3924,3925,3926,3927,3928,3930,3931,3932,3933,3934,3935,3936,3937,3938,3940,3941,3942,3943,3944,3945,3946,3947,
	3948,3949,3950,3951,3952,3953,3953,3954,3955,3956,3957,3958,3959,3960,3961,3961,3962,3963,3964,3965,3966,3966,
	3967,3968,3969,3969,3970,3971,3972,3972,3973,3974,3974,3975,3976,3976,3977,3978,3978,3979,3980,3980,3981,3981,
	3982,3983,3983,3984,3984,3985,3985,3986,3986,3987,3987,3988,3988,3989,3989,3990,3990,3990,3991,3991,3992,3992,
	3992,3993,3993,3993,3994,3994,3994,3995,3995,3995,3996,3996,3996,3996,3997,3997,3997,3997,3997,3998,3998,3998,
	3998,3998,3998,3999,3999,3999,3999,3999,3999,3999,3999,3999,3999,3999,3999,3999,3999,3999,3999,3999,3999,3999,
	3999,3999,3999,3999,3999,3999,3999,3999,3999,3999,3998,3998,3998,3998,3998,3998,3997,3997,3997,3997,3997,3996,
	3996,3996,3996,3995,3995,3995,3994,3994,3994,3993,3993,3993,3992,3992,3992,3991,3991,3990,3990,3990,3989,3989,
	3988,3988,3987,3987,3986,3986,3985,3985,3984,3984,3983,3983,3982,3981,3981,3980,3980,3979,3978,3978,3977,3976,
	3976,3975,3974,3974,3973,3972,3972,3971,3970,3969,3969,3968,3967,3966,3966,3965,3964,3963,3962,3961,3961,3960,
	3959,3958,3957,3956,3955,3954,3953,3953,3952,3951,3950,3949,3948,3947,3946,3945,3944,3943,3942,3941,3940,3939,
	3937,3936,3935,3934,3933,3932,3931,3930,3929,3927,3926,3925,3924,3923,3921,3920,3919,3918,3917,3915,3914,3913,
	3912,3910,3909,3908,3906,3905,3904,3902,3901,3900,3898,3897,3896,3894,3893,3891,3890,3888,3887,3886,3884,3883,
	3881,3880,3878,3877,3875,3874,3872,3871,3869,3867,3866,3864,3863,3861,3860,3858,3856,3855,3853,3851,3850,3848,
	3846,3845,3843,3841,3840,3838,3836,3834,3833,3831,3829,3827,3826,3824,3822,3820,3818,3816,3815,3813,3811,3809,
	3807,3805,3803,3802,3800,3798,3796,3794,3792,3790,3788,3786,3784,3782,3780,3778,3776,3774,3772,3770,3768,3766,
	3764,3762,3760,3757,3755,3753,3751,3749,3747,3745,3742,3740,3738,3736,3734,3732,3729,3727,3725,3723,3720,3718,
	3716,3714,3711,3709,3707,3704,3702,3700,3697,3695,3693,3690,3688,3686,3683,3681,3678,3676,3674,3671,3669,3666,
	3664,3661,3659,3656,3654,3651,3649,3646,3644,3641,3639,3636,3634,3631,3629,3626,3623,3621,3618,3616,3613,3610,
	3608,3605,3602,3600,3597,3594,3592,3589,3586,3583,3581,3578,3575,3573,3570,3567,3564,3561,3559,3556,3553,3550,
	3547,3545,3542,3539,3536,3533,3530,3527,3524,3521,3519,3516,3513,3510,3507,3504,3501,3498,3495,3492,3489,3486,
	3483,3480,3477,3474,3471,3468,3465,3462,3459,3456,3452,3449,3446,3443,3440,3437,3434,3431,3427,3424,3421,3418,
	3415,3411,3408,3405,3402,3399,3395,3392,3389,3386,3382,3379,3376,3372,3369,3366,3363,3359,3356,3353,3349,3346,
	3342,3339,3336,3332,3329,3326,3322,3319,3315,3312,3308,3305,3301,3298,3295,3291,3288,3284,3281,3277,3274,3270,
	3266,3263,3259,3256,3252,3249,3245,3241,3238,3234,3231,3227,3223,3220,3216,3212,3209,3205,3201,3198,3194,3190,
	3187,3183,3179,3176,3172,3168,3164,3161,3157,3153,3149,3145,3142,3138,3134,3130,3126,3123,3119,3115,3111,3107,
	3103,3099,3096,3092,3088,3084,3080,3076,3072,3068,3064,3060,3056,3052,3048,3044,3041,3037,3033,3029,3025,3020,
	3016,3012,3008,3004,3000,2996,2992,2988,2984,2980,2976,2972,2968,2963,2959,2955,2951,2947,2943,2939,2934,2930,
	2926,2922,2918,2914,2909,2905,2901,2897,2892,2888,2884,2880,2875,2871,2867,2863,2858,2854,2850,2845,2841,2837,
	2832,2828,2824,2819,2815,2811,2806,2802,2798,2793,2789,2784,2780,2776,2771,2767,2762,2758,2753,2749,2745,2740,
	2736,2731,2727,2722,2718,2713,2709,2704,2700,2695,2690,2686,2681,2677,2672,2668,2663,2659,2654,2649,2645,2640,
	2636,2631,2626,2622,2617,2612,2608,2603,2598,2594,2589,2584,2580,2575,2570,2566,2561,2556,2551,2547,2542,2537,
	2533,2528,2523,2518,2514,2509,2504,2499,2494,2490,2485,2480,2475,2470,2465,2461,2456,2451,2446,2441,2436,2432,
	2427,2422,2417,2412,2407,2402,2397,2392,2387,2383,2378,2373,2368,2363,2358,2353,2348,2343,2338,2333,2328,2323,
	2318,2313,2308,2303,2298,2293,2288,2283,2278,2273,2268,2263,2258,2253,2247,2242,2237,2232,2227,2222,2217,2212,
	2207,2202,2196,2191,2186,2181,2176,2171,2166,2160,2155,2150,2145,2140,2135,2129,2124,2119,2114,2109,2103,2098,
	2093,2088,2082,2077,2072,2067,2061,2056,2051,2046,2040,2035,2030,2025,2019,2014,2009,2003,1998,1993,1987,1982,
	1977,1971,1966,1961,1955,1950,1945,1939,1934,1929,1923,1918,1912,1907,1902,1896,1891,1885,1880,1875,1869,1864,
	1858,1853,1847,1842,1836,1831,1826,1820,1815,1809,1804,1798,1793,1787,1782,1776,1771,1765,1760,1754,1749,1743,
	1738,1732,1727,1721,1716,1710,1704,1699,1693,1688,1682,1677,1671,1666,1660,1654,1649,1643,1638,1632,1626,1621,
	1615,1610,1604,1598,1593,1587,1581,1576,1570,1564,1559,1553,1548,1542,1536,1531,1525,1519,1514,1508,1502,1496,
	1491,1485,1479,1474,1468,1462,1457,1451,1445,1439,1434,1428,1422,1416,1411,1405,1399,1393,1388,1382,1376,1370,
	1365,1359,1353,1347,1342,1336,1330,1324,1318,1313,1307,1301,1295,1289,1284,1278,1272,1266,1260,1255,1249,1243,
	1237,1231,1225,1220,1214,1208,1202,1196,1190,1184,1179,1173,1167,1161,1155,1149,1143,1137,1132,1126,1120,1114,
	1108,1102,1096,1090,1084,1078,1073,1067,1061,1055,1049,1043,1037,1031,1025,1019,1013,1007,1001,996,990,984,978,
	972,966,960,954,948,942,936,930,924,918,912,906,900,894,888,882,876,870,864,858,852,846,840,834,828,822,816,810,
	804,798,792,786,780,774,768,762,756,750,744,738,732,726,720,714,708,702,696,690,684,678,672,666,659,653,647,641,
	635,629,623,617,611,605,599,593,587,581,575,569,562,556,550,544,538,532,526,520,514,508,502,496,489,483,477,471,
	465,459,453,447,441,435,429,422,416,410,404,398,392,386,380,374,367,361,355,349,343,337,331,325,319,312,306,300,
	294,288,282,276,270,264,257,251,245,239,233,227,221,215,208,202,196,190,184,178,172,165,159,153,147,141,135,129,
	123,116,110,104,98,92,86,80,73,67,61,55,49,43,37,31,24,18,12,6,0,-5,-11,-18,-24,-30,-36,-42,-48,-54,-60,-67,-73,
	-79,-85,-91,-97,-103,-110,-116,-122,-128,-134,-140,-146,-152,-159,-165,-171,-177,-183,-189,-195,-202,-208,-214,
	-220,-226,-232,-238,-244,-251,-257,-263,-269,-275,-281,-287,-293,-299,-306,-312,-318,-324,-330,-336,-342,-348,
	-355,-361,-367,-373,-379,-385,-391,-397,-403,-410,-416,-422,-428,-434,-440,-446,-452,-458,-464,-470,-477,-483,
	-489,-495,-501,-507,-513,-519,-525,-531,-537,-544,-550,-556,-562,-568,-574,-580,-586,-592,-598,-604,-610,-616,
	-622,-628,-635,-641,-647,-653,-659,-665,-671,-677,-683,-689,-695,-701,-707,-713,-719,-725,-731,-737,-743,-749,
	-755,-761,-767,-773,-779,-785,-792,-798,-804,-810,-816,-822,-828,-834,-840,-846,-852,-858,-864,-870,-876,-882,
	-887,-893,-899,-905,-911,-917,-923,-929,-935,-941,-947,-953,-959,-965,-971,-977,-983,-989,-995,-1001,-1007,-1013,
	-1019,-1025,-1030,-1036,-1042,-1048,-1054,-1060,-1066,-1072,-1078,-1084,-1090,-1095,-1101,-1107,-1113,-1119,-1125,
	-1131,-1137,-1143,-1149,-1154,-1160,-1166,-1172,-1178,-1184,-1190,-1195,-1201,-1207,-1213,-1219,-1225,-1231,-1236,
	-1242,-1248,-1254,-1260,-1265,-1271,-1277,-1283,-1289,-1295,-1300,-1306,-1312,-1318,-1324,-1329,-1335,-1341,-1347,
	-1352,-1358,-1364,-1370,-1376,-1381,-1387,-1393,-1399,-1404,-1410,-1416,-1422,-1427,-1433,-1439,-1444,-1450,-1456,
	-1462,-1467,-1473,-1479,-1484,-1490,-1496,-1501,-1507,-1513,-1519,-1524,-1530,-1536,-1541,-1547,-1552,-1558,-1564,
	-1569,-1575,-1581,-1586,-1592,-1598,-1603,-1609,-1614,-1620,-1626,-1631,-1637,-1642,-1648,-1654,-1659,-1665,-1670,
	-1676,-1682,-1687,-1693,-1698,-1704,-1709,-1715,-1720,-1726,-1731,-1737,-1743,-1748,-1754,-1759,-1765,-1770,-1776,
	-1781,-1787,-1792,-1798,-1803,-1809,-1814,-1819,-1825,-1830,-1836,-1841,-1847,-1852,-1858,-1863,-1868,-1874,-1879,
	-1885,-1890,-1896,-1901,-1906,-1912,-1917,-1922,-1928,-1933,-1939,-1944,-1949,-1955,-1960,-1965,-1971,-1976,-1981,
	-1987,-1992,-1997,-2003,-2008,-2013,-2019,-2024,-2029,-2034,-2040,-2045,-2050,-2056,-2061,-2066,-2071,-2077,-2082,
	-2087,-2092,-2097,-2103,-2108,-2113,-2118,-2124,-2129,-2134,-2139,-2144,-2149,-2155,-2160,-2165,-2170,-2175,-2180,
	-2186,-2191,-2196,-2201,-2206,-2211,-2216,-2221,-2227,-2232,-2237,-2242,-2247,-2252,-2257,-2262,-2267,-2272,-2277,
	-2282,-2287,-2292,-2297,-2302,-2307,-2312,-2317,-2322,-2327,-2332,-2337,-2342,-2347,-2352,-2357,-2362,-2367,-2372,
	-2377,-2382,-2387,-2392,-2397,-2402,-2407,-2411,-2416,-2421,-2426,-2431,-2436,-2441,-2446,-2450,-2455,-2460,-2465,
	-2470,-2475,-2479,-2484,-2489,-2494,-2499,-2503,-2508,-2513,-2518,-2522,-2527,-2532,-2537,-2541,-2546,-2551,-2556,
	-2560,-2565,-2570,-2574,-2579,-2584,-2589,-2593,-2598,-2603,-2607,-2612,-2616,-2621,-2626,-2630,-2635,-2640,-2644,
	-2649,-2653,-2658,-2663,-2667,-2672,-2676,-2681,-2685,-2690,-2694,-2699,-2704,-2708,-2713,-2717,-2722,-2726,-2731,
	-2735,-2739,-2744,-2748,-2753,-2757,-2762,-2766,-2771,-2775,-2779,-2784,-2788,-2793,-2797,-2801,-2806,-2810,-2815,
	-2819,-2823,-2828,-2832,-2836,-2841,-2845,-2849,-2854,-2858,-2862,-2866,-2871,-2875,-2879,-2883,-2888,-2892,-2896,
	-2900,-2905,-2909,-2913,-2917,-2921,-2926,-2930,-2934,-2938,-2942,-2946,-2951,-2955,-2959,-2963,-2967,-2971,-2975,
	-2979,-2984,-2988,-2992,-2996,-3000,-3004,-3008,-3012,-3016,-3020,-3024,-3028,-3032,-3036,-3040,-3044,-3048,-3052,
	-3056,-3060,-3064,-3068,-3072,-3076,-3080,-3083,-3087,-3091,-3095,-3099,-3103,-3107,-3111,-3114,-3118,-3122,-3126,
	-3130,-3134,-3137,-3141,-3145,-3149,-3153,-3156,-3160,-3164,-3168,-3171,-3175,-3179,-3183,-3186,-3190,-3194,-3197,
	-3201,-3205,-3208,-3212,-3216,-3219,-3223,-3227,-3230,-3234,-3237,-3241,-3245,-3248,-3252,-3255,-3259,-3262,-3266,
	-3270,-3273,-3277,-3280,-3284,-3287,-3291,-3294,-3298,-3301,-3305,-3308,-3311,-3315,-3318,-3322,-3325,-3329,-3332,
	-3335,-3339,-3342,-3345,-3349,-3352,-3355,-3359,-3362,-3365,-3369,-3372,-3375,-3379,-3382,-3385,-3388,-3392,-3395,
	-3398,-3401,-3405,-3408,-3411,-3414,-3417,-3421,-3424,-3427,-3430,-3433,-3436,-3440,-3443,-3446,-3449,-3452,-3455,
	-3458,-3461,-3464,-3467,-3470,-3474,-3477,-3480,-3483,-3486,-3489,-3492,-3495,-3498,-3501,-3504,-3506,-3509,-3512,
	-3515,-3518,-3521,-3524,-3527,-3530,-3533,-3536,-3538,-3541,-3544,-3547,-3550,-3553,-3555,-3558,-3561,-3564,-3567,
	-3569,-3572,-3575,-3578,-3580,-3583,-3586,-3589,-3591,-3594,-3597,-3599,-3602,-3605,-3607,-3610,-3613,-3615,-3618,
	-3620,-3623,-3626,-3628,-3631,-3633,-3636,-3639,-3641,-3644,-3646,-3649,-3651,-3654,-3656,-3659,-3661,-3664,-3666,
	-3668,-3671,-3673,-3676,-3678,-3681,-3683,-3685,-3688,-3690,-3692,-3695,-3697,-3700,-3702,-3704,-3706,-3709,-3711,
	-3713,-3716,-3718,-3720,-3722,-3725,-3727,-3729,-3731,-3733,-3736,-3738,-3740,-3742,-3744,-3747,-3749,-3751,-3753,
	-3755,-3757,-3759,-3761,-3763,-3766,-3768,-3770,-3772,-3774,-3776,-3778,-3780,-3782,-3784,-3786,-3788,-3790,-3792,
	-3794,-3796,-3797,-3799,-3801,-3803,-3805,-3807,-3809,-3811,-3813,-3814,-3816,-3818,-3820,-3822,-3824,-3825,-3827,
	-3829,-3831,-3832,-3834,-3836,-3838,-3839,-3841,-3843,-3844,-3846,-3848,-3850,-3851,-3853,-3854,-3856,-3858,-3859,
	-3861,-3863,-3864,-3866,-3867,-3869,-3870,-3872,-3873,-3875,-3876,-3878,-3879,-3881,-3882,-3884,-3885,-3887,-3888,
	-3890,-3891,-3893,-3894,-3895,-3897,-3898,-3899,-3901,-3902,-3904,-3905,-3906,-3907,-3909,-3910,-3911,-3913,-3914,
	-3915,-3916,-3918,-3919,-3920,-3921,-3923,-3924,-3925,-3926,-3927,-3928,-3930,-3931,-3932,-3933,-3934,-3935,-3936,
	-3937,-3938,-3939,-3941,-3942,-3943,-3944,-3945,-3946,-3947,-3948,-3949,-3950,-3951,-3952,-3952,-3953,-3954,-3955,
	-3956,-3957,-3958,-3959,-3960,-3961,-3961,-3962,-3963,-3964,-3965,-3965,-3966,-3967,-3968,-3969,-3969,-3970,-3971,
	-3972,-3972,-3973,-3974,-3974,-3975,-3976,-3976,-3977,-3978,-3978,-3979,-3980,-3980,-3981,-3981,-3982,-3983,-3983,
	-3984,-3984,-3985,-3985,-3986,-3986,-3987,-3987,-3988,-3988,-3989,-3989,-3990,-3990,-3990,-3991,-3991,-3992,-3992,
	-3992,-3993,-3993,-3993,-3994,-3994,-3994,-3995,-3995,-3995,-3996,-3996,-3996,-3996,-3997,-3997,-3997,-3997,-3997,
	-3998,-3998,-3998,-3998,-3998,-3998,-3999,-3999,-3999,-3999,-3999,-3999,-3999,-3999,-3999,-3999,-3999,-3999,-3999,
	-3999,-3999,-3999,-3999,-3999,-3999,-3999,-3999,-3999,-3999,-3999,-3999,-3999,-3999,-3999,-3999,-3998,-3998,-3998,
	-3998,-3998,-3998,-3997,-3997,-3997,-3997,-3997,-3996,-3996,-3996,-3996,-3995,-3995,-3995,-3994,-3994,-3994,-3993,
	-3993,-3993,-3992,-3992,-3992,-3991,-3991,-3990,-3990,-3990,-3989,-3989,-3988,-3988,-3987,-3987,-3986,-3986,-3985,
	-3985,-3984,-3984,-3983,-3983,-3982,-3981,-3981,-3980,-3980,-3979,-3978,-3978,-3977,-3977,-3976,-3975,-3975,-3974,
	-3973,-3972,-3972,-3971,-3970,-3969,-3969,-3968,-3967,-3966,-3966,-3965,-3964,-3963,-3962,-3962,-3961,-3960,-3959,
	-3958,-3957,-3956,-3955,-3954,-3954,-3953,-3952,-3951,-3950,-3949,-3948,-3947,-3946,-3945,-3944,-3943,-3942,-3941,
	-3940,-3939,-3938,-3936,-3935,-3934,-3933,-3932,-3931,-3930,-3929,-3927,-3926,-3925,-3924,-3923,-3922,-3920,-3919,
	-3918,-3917,-3915,-3914,-3913,-3912,-3910,-3909,-3908,-3906,-3905,-3904,-3902,-3901,-3900,-3898,-3897,-3896,-3894,
	-3893,-3891,-3890,-3889,-3887,-3886,-3884,-3883,-3881,-3880,-3878,-3877,-3875,-3874,-3872,-3871,-3869,-3868,-3866,
	-3864,-3863,-3861,-3860,-3858,-3856,-3855,-3853,-3851,-3850,-3848,-3846,-3845,-3843,-3841,-3840,-3838,-3836,-3834,
	-3833,-3831,-3829,-3827,-3826,-3824,-3822,-3820,-3818,-3817,-3815,-3813,-3811,-3809,-3807,-3805,-3804,-3802,-3800,
	-3798,-3796,-3794,-3792,-3790,-3788,-3786,-3784,-3782,-3780,-3778,-3776,-3774,-3772,-3770,-3768,-3766,-3764,-3762,
	-3760,-3758,-3755,-3753,-3751,-3749,-3747,-3745,-3743,-3740,-3738,-3736,-3734,-3732,-3729,-3727,-3725,-3723,-3721,
	-3718,-3716,-3714,-3711,-3709,-3707,-3705,-3702,-3700,-3698,-3695,-3693,-3691,-3688,-3686,-3683,-3681,-3679,-3676,
	-3674,-3671,-3669,-3666,-3664,-3662,-3659,-3657,-3654,-3652,-3649,-3647,-3644,-3642,-3639,-3636,-3634,-3631,-3629,
	-3626,-3624,-3621,-3618,-3616,-3613,-3610,-3608,-3605,-3602,-3600,-3597,-3594,-3592,-3589,-3586,-3584,-3581,-3578,
	-3575,-3573,-3570,-3567,-3564,-3562,-3559,-3556,-3553,-3550,-3548,-3545,-3542,-3539,-3536,-3533,-3530,-3527,-3525,
	-3522,-3519,-3516,-3513,-3510,-3507,-3504,-3501,-3498,-3495,-3492,-3489,-3486,-3483,-3480,-3477,-3474,-3471,-3468,
	-3465,-3462,-3459,-3456,-3453,-3450,-3446,-3443,-3440,-3437,-3434,-3431,-3428,-3424,-3421,-3418,-3415,-3412,-3408,
	-3405,-3402,-3399,-3396,-3392,-3389,-3386,-3383,-3379,-3376,-3373,-3369,-3366,-3363,-3359,-3356,-3353,-3349,-3346,
	-3343,-3339,-3336,-3333,-3329,-3326,-3322,-3319,-3315,-3312,-3309,-3305,-3302,-3298,-3295,-3291,-3288,-3284,-3281,
	-3277,-3274,-3270,-3267,-3263,-3260,-3256,-3252,-3249,-3245,-3242,-3238,-3234,-3231,-3227,-3224,-3220,-3216,-3213,
	-3209,-3205,-3202,-3198,-3194,-3191,-3187,-3183,-3180,-3176,-3172,-3168,-3165,-3161,-3157,-3153,-3149,-3146,-3142,
	-3138,-3134,-3130,-3127,-3123,-3119,-3115,-3111,-3107,-3104,-3100,-3096,-3092,-3088,-3084,-3080,-3076,-3072,-3068,
	-3065,-3061,-3057,-3053,-3049,-3045,-3041,-3037,-3033,-3029,-3025,-3021,-3017,-3013,-3009,-3005,-3001,-2996,-2992,
	-2988,-2984,-2980,-2976,-2972,-2968,-2964,-2960,-2955,-2951,-2947,-2943,-2939,-2935,-2931,-2926,-2922,-2918,-2914,
	-2910,-2905,-2901,-2897,-2893,-2888,-2884,-2880,-2876,-2871,-2867,-2863,-2859,-2854,-2850,-2846,-2841,-2837,-2833,
	-2828,-2824,-2820,-2815,-2811,-2807,-2802,-2798,-2793,-2789,-2785,-2780,-2776,-2771,-2767,-2763,-2758,-2754,-2749,
	-2745,-2740,-2736,-2731,-2727,-2722,-2718,-2713,-2709,-2704,-2700,-2695,-2691,-2686,-2682,-2677,-2673,-2668,-2663,
	-2659,-2654,-2650,-2645,-2640,-2636,-2631,-2627,-2622,-2617,-2613,-2608,-2603,-2599,-2594,-2589,-2585,-2580,-2575,
	-2571,-2566,-2561,-2557,-2552,-2547,-2542,-2538,-2533,-2528,-2523,-2519,-2514,-2509,-2504,-2499,-2495,-2490,-2485,
	-2480,-2475,-2471,-2466,-2461,-2456,-2451,-2446,-2442,-2437,-2432,-2427,-2422,-2417,-2412,-2407,-2402,-2398,-2393,
	-2388,-2383,-2378,-2373,-2368,-2363,-2358,-2353,-2348,-2343,-2338,-2333,-2328,-2323,-2318,-2313,-2308,-2303,-2298,
	-2293,-2288,-2283,-2278,-2273,-2268,-2263,-2258,-2253,-2248,-2243,-2238,-2233,-2227,-2222,-2217,-2212,-2207,-2202,
	-2197,-2192,-2187,-2181,-2176,-2171,-2166,-2161,-2156,-2150,-2145,-2140,-2135,-2130,-2124,-2119,-2114,-2109,-2104,
	-2098,-2093,-2088,-2083,-2078,-2072,-2067,-2062,-2056,-2051,-2046,-2041,-2035,-2030,-2025,-2020,-2014,-2009,-2004,
	-1998,-1993,-1988,-1982,-1977,-1972,-1966,-1961,-1956,-1950,-1945,-1940,-1934,-1929,-1923,-1918,-1913,-1907,-1902,
	-1897,-1891,-1886,-1880,-1875,-1869,-1864,-1859,-1853,-1848,-1842,-1837,-1831,-1826,-1820,-1815,-1810,-1804,-1799,
	-1793,-1788,-1782,-1777,-1771,-1766,-1760,-1755,-1749,-1744,-1738,-1732,-1727,-1721,-1716,-1710,-1705,-1699,-1694,
	-1688,-1683,-1677,-1671,-1666,-1660,-1655,-1649,-1644,-1638,-1632,-1627,-1621,-1615,-1610,-1604,-1599,-1593,-1587,
	-1582,-1576,-1570,-1565,-1559,-1554,-1548,-1542,-1537,-1531,-1525,-1520,-1514,-1508,-1502,-1497,-1491,-1485,-1480,
	-1474,-1468,-1463,-1457,-1451,-1445,-1440,-1434,-1428,-1423,-1417,-1411,-1405,-1400,-1394,-1388,-1382,-1377,-1371,
	-1365,-1359,-1353,-1348,-1342,-1336,-1330,-1325,-1319,-1313,-1307,-1301,-1296,-1290,-1284,-1278,-1272,-1267,-1261,
	-1255,-1249,-1243,-1237,-1232,-1226,-1220,-1214,-1208,-1202,-1196,-1191,-1185,-1179,-1173,-1167,-1161,-1155,-1150,
	-1144,-1138,-1132,-1126,-1120,-1114,-1108,-1102,-1097,-1091,-1085,-1079,-1073,-1067,-1061,-1055,-1049,-1043,-1037,
	-1032,-1026,-1020,-1014,-1008,-1002,-996,-990,-984,-978,-972,-966,-960,-954,-948,-942,-936,-930,-924,-918,-912,-907,
	-901,-895,-889,-883,-877,-871,-865,-859,-853,-847,-841,-835,-829,-823,-817,-811,-805,-799,-793,-787,-781,-775,-769,
	-763,-756,-750,-744,-738,-732,-726,-720,-714,-708,-702,-696,-690,-684,-678,-672,-666,-660,-654,-648,-642,-636,-630,
	-624,-617,-611,-605,-599,-593,-587,-581,-575,-569,-563,-557,-551,-545,-539,-532,-526,-520,-514,-508,-502,-496,-490,
	-484,-478,-472,-465,-459,-453,-447,-441,-435,-429,-423,-417,-411,-405,-398,-392,-386,-380,-374,-368,-362,-356,-350,
	-343,-337,-331,-325,-319,-313,-307,-301,-294,-288,-282,-276,-270,-264,-258,-252,-246,-239,-233,-227,-221,-215,-209,
	-203,-197,-190,-184,-178,-172,-166,-160,-154,-147,-141,-135,-129,-123,-117,-111,-105,-98,-92,-86,-80,-74,-68,-62,
	-55,-49,-43,-37,-31,-25,-19,-13
};
*/
	int main(void)
 {	 
	delay_init();	    	 //延时函数初始化	  
	NVIC_Configuration(); 	 //设置NVIC中断分组2:2位抢占优先级，2位响应优先级
	uart_init(115200);	 	//串口初始化为9600
	LED_Init();		  		//初始化与LED连接的硬件接口

	CAN_deviceInit(500,CAN_Mode_Normal);
	
	 pid.err=0;
	 pid.lerr=0;
	 pid.plerr=0;
	 pid.kp=0.1;
	 pid.ki=0.01;
	 pid.kd=0.01;
	 
	 
	 //ID init
	{
		unsigned char setNodeId[]={3,4,1,127};
		clientNodeInfo(setNodeId,CAN_CLIENT_NUM);
	}
	delay_ms(1000);
	//check fault and reset it

	fault_Check(0,NodeId[3]);
	
	communication_Init(0);
	
	
	//NodeId[3]	
	printf("\nNodeId[3]---------------PDO 1800h CFG---------------\n");	
	{
		struct pDOCFG_STRUCT pdoCfg={0x1800,1,{0x60410010,0x60640020},2};
		pdo_Config(0,NodeId[3],pdoCfg);
		delay_ms(1000);
	}
	printf("\nNodeId[3]---------------PDO 1401h CFG---------------\n");
	{
		struct pDOCFG_STRUCT pdoCfg={0x1400,1,{0x60400010,0x60710010},2};
		pdo_Config(0,NodeId[3],pdoCfg);
		delay_ms(1000);
	}
/*

	//NodeId[3]	
	printf("\nNodeId[3]---------------PDO 1800h CFG---------------\n");	
	{
		struct pDOCFG_STRUCT pdoCfg={0x1800,1,{0x60410010,0x606c0020},2};
		pdo_Config(0,NodeId[3],pdoCfg);
		delay_ms(1000);
	}
	printf("\nNodeId[3]---------------PDO 1401h CFG---------------\n");
	{
		struct pDOCFG_STRUCT pdoCfg={0x1400,1,{0x60400010,0x60ff0020},2};
		pdo_Config(0,NodeId[3],pdoCfg);
		delay_ms(1000);
	}
	*/


	nmt_StateOperational(0,0);	


	driver_RunMode(0,NodeId[3],4);//NodeId[3]
	
	position_RangeLimitMin(0,NodeId[3],-5000000);
	position_RangeLimitMax(0,NodeId[3],5000000);
	position_SoftwareLimitMin(0,NodeId[3],-4000000);
	position_SoftwareLimitMax(0,NodeId[3],4000000);
	speed_MotorMax(0,NodeId[3],500000000);
	veolcity_profileMAX(0,NodeId[3],400000000);
	veolcity_profile(0,NodeId[3],40000000);
	acceleration_profile(0,NodeId[3],990000000);
	deceleration_profile(0,NodeId[3],990000000);
	acceleration_Max(0,NodeId[3],1000000000);
	deceleration_Max(0,NodeId[3],1000000000);
	
	toeque_Max(0,NodeId[3],1250);
	current_Max(0,NodeId[3],1250);
	current_MotorRated(0,NodeId[3],11000);
	torque_MotorRated(0,NodeId[3],996);
	
	
	
	sdo_StatusTest();
	TIM3_Int_Init(719,199);//999
	//NodeId[3]
	//heartbeat_ClientSend(0,NodeId[3],30000);
	//heartbeat_MasterSend(0,NodeId[3],500);

	
 	while(1)
	{

	}
}


void sdo_StatusTest()
{
	//NodeId[3]
	printf("\nNodeId[3]---------------set 0x06---------------\n");
	sdo_DriverStatusChange(0, NodeId[3],0x06,READY_TO_SWITCH_ON);
	printf("\nNodeId[3]---------------set 0x07---------------\n");
	sdo_DriverStatusChange(0, NodeId[3],0x07,SWITCH_ON);
	printf("\nNodeId[3]---------------set 0x0f---------------\n");
	sdo_DriverStatusChange(0, NodeId[3],0x0f,OPERATION_ENABLE);
}




void TIM3_Int_Init(u16 arr,u16 psc)
{
  TIM_TimeBaseInitTypeDef  TIM_TimeBaseStructure;
	NVIC_InitTypeDef NVIC_InitStructure;

	RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM3, ENABLE); //时钟使能
	
	//定时器TIM3初始化
	TIM_TimeBaseStructure.TIM_Period = arr; //设置在下一个更新事件装入活动的自动重装载寄存器周期的值	
	TIM_TimeBaseStructure.TIM_Prescaler =psc; //设置用来作为TIMx时钟频率除数的预分频值
	TIM_TimeBaseStructure.TIM_ClockDivision = TIM_CKD_DIV1; //设置时钟分割:TDTS = Tck_tim
	TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up;  //TIM向上计数模式
	TIM_TimeBaseInit(TIM3, &TIM_TimeBaseStructure); //根据指定的参数初始化TIMx的时间基数单位
 
	TIM_ITConfig(TIM3,TIM_IT_Update,ENABLE ); //使能指定的TIM3中断,允许更新中断

	//中断优先级NVIC设置
	NVIC_InitStructure.NVIC_IRQChannel = TIM3_IRQn;  //TIM3中断
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0;  //先占优先级0级
	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 3;  //从优先级3级
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE; //IRQ通道被使能
	NVIC_Init(&NVIC_InitStructure);  //初始化NVIC寄存器

	TIM_Cmd(TIM3, ENABLE);  //使能TIMx					 
}

const unsigned long int targetP=10000;

//定时器3中断服务程序
void TIM3_IRQHandler(void)   //TIM3中断
{
		extern long int tim_cnt;
		unsigned char dat[6]={0x0f,0x00,0x00,0x00,0x00,0x00};
		static int cnt=0;
		static int temp=200;
		signed long int actualP=0; 
		if (TIM_GetITStatus(TIM3, TIM_IT_Update) != RESET)  //检查TIM3更新中断发生与否
		{		
			TIM_ClearITPendingBit(TIM3, TIM_IT_Update  );  //清除TIMx更新中断标志 
			/*
			temp=(short)(sinDat[cnt]/10);
			//if(temp>250)
			//	temp=0;
			//temp=1092266;
			memcpy(dat+2,&temp,2);
					
			pdo_SingleSend(0,NodeId[3],0x1400,dat,4);//NodeId[3]
			sync_Send(0);		
			delay_us(100);
		
			cnt+=8;
			if(RPdoBuf[0][3].flag==1)
			{
				memcpy(&actualP,RPdoBuf[0][3].dat+2,4);
				printf("%ld ",actualP);
			}
			
			
			
			if(cnt>4095)
			{
				cnt=0;
				LED1=!LED1;
			}
			*/
			

			temp+=pid.pidv;
			if(temp>500)
				temp=500;
			if(temp<-500)
				temp=-500;
			memcpy(dat+2,&temp,2);

			pdo_SingleSend(0,NodeId[3],0x1400,dat,4);//NodeId[3]
			sync_Send(0);		
			delay_us(80);
		
			memcpy(&actualP,RPdoBuf[0][3].dat+2,4);		
			pid.err=targetP-actualP;
			pid.pidv=pid.kp*(pid.err-pid.lerr)+pid.ki*pid.err+pid.kd*(pid.err-2*pid.lerr+pid.plerr);
			
			pid.plerr=pid.lerr;
			pid.lerr=pid.err;
			
			printf("%ld ",actualP);
			
			cnt+=8;
			if(cnt>4096)
			{
				cnt=0;
				LED1=!LED1;
			}
			
		}
}


